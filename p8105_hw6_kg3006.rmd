---
title: "p8105_hw6_kg3006"
author: "Kevin Guzman"
date: "2025-11-25"
output: github_document
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Loading appropriate libraries 
library(tidyverse)
library(purrr)
library(broom)
library(p8105.datasets)
```

## Problem 1

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#Loading library from github website 
homicides <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

#Creating city, state variable using "city", "state" 
homicides <- homicides %>%
  mutate(city_state = paste(city, state, sep = ", ")) %>% 
  #Creating binary variable (solved v. not solved) from disposition column
  mutate(solved = ifelse(disposition == "Closed by arrest", 1, 0)) %>% 
  #Omiting city_states Dallas, Tx, Phoenix, AZ, and Kansas City, MO for not reporting race 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO"))) %>% 
  #Omitting Tulsa, AL (entery mistake) 
  filter(city_state != "Tulsa, AL") %>% 
  #Only keeping those who are black or white race in victim_race
  filter(victim_race==c("Black", "White")) %>% 
  #Changing age to nmeric 
  mutate(victim_age = as.numeric(victim_age)) 
```

### Comparing solving crimes in males v. females in Baltimore, MD
 
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#Baltiomore Analysis 
  #Filtering for Baltimore, MD to new dataset
  baltimore_homicides <- homicides %>%
    filter(city_state == "Baltimore, MD")
  
  #Logistic regression model predicting whether homicide is solved based on victim age, sex, and race as predictors 
  baltimore_glm <- glm(solved ~ victim_age + victim_sex + victim_race, 
                      data = baltimore_homicides,
                      family=binomial)
  #Saving as an R object 
  saveRDS(baltimore_glm, "Output/baltimore_glm.rds")
  
  #Getting adjusted odds ratios 
  baltimore_glm %>% 
    broom::tidy(exponentiate = TRUE, conf.int = TRUE)
```

In Balitmore, MD, the adjusted odds of a homicide being solved for Males are `r round( (baltimore_glm %>% broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>% filter(term == "victim_sexMale"))$estimate, 2)` (95% CI: `r round( (baltimore_glm %>% broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>% filter(term == "victim_sexMale"))$conf.low, 2)` - `r round( (baltimore_glm %>% broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>% filter(term == "victim_sexMale"))$conf.high, 2)`) times the odds for female victime, holding all other variables constant.

### All cities 

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=8, fig.height=10}
# Making odds ratio for each city using purr and piplein 
  city_odds_ratio <- homicides %>% 
    #Group by city_state 
    group_by(city_state) %>% 
    #Nest data
    nest() %>% 
    #Creating function to run logistic regression for each city
    mutate(
      model = map(data, ~ glm(solved ~ victim_age + victim_sex + victim_race,
                              data = .x,
                              family = binomial)),
    #Getting adjusted odds ratios for each city
    tidy = map(model, ~ broom::tidy(.x, exponentiate = TRUE, conf.int = TRUE))) %>% 
    select(city_state, tidy) %>% 
    unnest(cols = c(tidy)) %>% 
    #Filtering for victim_sexMale term only
    filter(term == "victim_sexMale") %>% 
    #Only keep estimates and OR high and low 
    select(city_state, estimate, conf.low, conf.high) %>%
    #Arranging in descending order of odds ratio
    arrange(desc(estimate)) 

    #Creating plot that shows estimate OR and CI for each city 
    plot1 <- city_odds_ratio %>% 
      ggplot(aes(x = reorder(city_state, estimate), y = estimate)) +
      # Vertical reference line at OR = 1
      geom_hline(yintercept = 1, linetype = "dashed", color = "gray40", linewidth = 0.7) +
      geom_point(size = 3, color = "black") +
      geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = 0.15,
                color = "gray20",
                linewidth = 0.6) +
      coord_flip() +
      labs(
        title = "Homicide Solving by Victim Sex (Male vs. Females)",
        x = "City, State",
        y = "Adjusted Odds Ratio (Male vs. Female)"
      )  +
      theme_minimal(base_size = 14) +
      theme(
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 12, color = "gray25"),
        axis.title = element_text(face = "bold"),
        axis.text = element_text(color = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_line(color = "gray90"),
        plot.margin = margin(10, 20, 10, 10)
      ) + 
      #Adding caption 
      labs(caption = "Adjusted odds ratio of the probability of a homicide being solved based on the victim's sex")
    
    plot1

```

Rates of homicides being solved differ by cities. The city with the highest adjusted odds of a homicide being solved when the victim is male compared to female is `r city_odds_ratio$city_state[which.max(city_odds_ratio$estimate)]` with an adjusted odds ratio of `r round(max(city_odds_ratio$estimate), 2)` (95% CI: `r round(city_odds_ratio$conf.low[which.max(city_odds_ratio$estimate)], 2)` - `r round(city_odds_ratio$conf.high[which.max(city_odds_ratio$estimate)], 2)`). The city with the lowest adjusted odds of a homicide being solved when the victim is male compared to female is `r city_odds_ratio$city_state[which.min(city_odds_ratio$estimate)]` with an adjusted odds ratio of `r round(min(city_odds_ratio$estimate), 2)` (95% CI: `r round(city_odds_ratio$conf.low[which.min(city_odds_ratio$estimate)], 2)` - `r round(city_odds_ratio$conf.high[which.min(city_odds_ratio$estimate)], 2)`).

## Problem 2 

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#Loading library from p8105.datasets 
  data("weather_df")

#Viewing 
  head(weather_df)


```



